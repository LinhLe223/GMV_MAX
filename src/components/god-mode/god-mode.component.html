<div class="space-y-8">
  <div>
    <h2 class="text-2xl font-bold text-gray-900">ğŸ† GOD MODE - Trung tÃ¢m Chá»‰ huy</h2>
    <p class="mt-1 text-sm text-gray-500">Dá»¯ liá»‡u há»£p nháº¥t tá»« Ads, ÄÆ¡n hÃ ng, vÃ  Tá»“n kho Ä‘á»ƒ Ä‘Æ°a ra "Sá»± tháº­t Cuá»‘i cÃ¹ng": Lá»£i Nhuáº­n RÃ²ng.</p>
  </div>

  <!-- Financial Health Bar -->
  @if(financialHealthBarData(); as health) {
    <div class="bg-white p-4 rounded-lg shadow border">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Sá»©c Khá»e DÃ²ng Tiá»n (NMV: {{ health.totalNmv | number:'1.0-0' }} Ä‘)</h3>
        <div class="w-full flex h-6 rounded-full overflow-hidden text-xs text-white font-semibold">
            <div class="flex items-center justify-center bg-blue-500" [style.width.%]="health.cogsPercent" title="GiÃ¡ vá»‘n: {{ health.cogsPercent | number:'1.1-1' }}%">COGS</div>
            <div class="flex items-center justify-center bg-red-500" [style.width.%]="health.adsPercent" title="Chi phÃ­ Ads: {{ health.adsPercent | number:'1.1-1' }}%">ADS</div>
            <div class="flex items-center justify-center bg-yellow-500" [style.width.%]="health.feesPercent" title="PhÃ­ & Hoa há»“ng: {{ health.feesPercent | number:'1.1-1' }}%">PHÃ</div>
            <div class="flex items-center justify-center" [class]="health.netProfitPercent >= 0 ? 'bg-green-500' : 'bg-gray-700'" [style.width.%]="health.netProfitPercent >= 0 ? health.netProfitPercent : 100 - health.cogsPercent - health.adsPercent - health.feesPercent" [title]="'Lá»£i nhuáº­n: ' + (health.netProfitPercent | number:'1.1-1') + '%'">
                @if(health.netProfitPercent >= 5) { LÃƒI }
            </div>
        </div>
    </div>
  }

  <!-- V2: Executive Summary -->
  @if(summary(); as s) {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
        <div class="text-gray-500 text-sm">Doanh Thu Thá»±c (NMV)</div>
        <div class="text-2xl font-bold text-blue-700">{{ s.totalNMV | number:'1.0-0' }} â‚«</div>
        <div class="text-xs text-gray-400">GMV (ÄÆ¡n): {{ s.totalRevenue | number:'1.0-0' }} â‚«</div>
      </div>
      
      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
        <div class="text-gray-500 text-sm">Lá»£i Nhuáº­n RÃ²ng</div>
        <div class="text-2xl font-bold" [class.text-red-600]="s.totalNetProfit < 0" [class.text-green-600]="s.totalNetProfit >= 0">
          {{ s.totalNetProfit | number:'1.0-0' }} â‚«
        </div>
        <div class="text-xs text-gray-400">Tá»« {{ s.totalNMV | number:'1.0-0' }} Ä‘ NMV</div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
        <div class="text-gray-500 text-sm">Hiá»‡u Quáº£ KOC</div>
        <div class="text-2xl font-bold">{{ s.activeKoc }} / {{ s.totalKoc }}</div>
        <div class="text-xs text-gray-400">Äang ra Ä‘Æ¡n</div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
        <div class="text-gray-500 text-sm">Tá»· Lá»‡ HoÃ n/Há»§y</div>
        <div class="text-2xl font-bold text-red-600">{{ s.avgReturnRate | number:'1.1-1' }}%</div>
        <div class="text-xs text-gray-400">TrÃªn tá»•ng Ä‘Æ¡n</div>
      </div>
    </div>
  }

  <!-- V2: AI Assistant -->
  <div class="bg-indigo-50 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4">
    <div>
      <h3 class="font-bold text-indigo-800">ğŸ¤– Trá»£ lÃ½ AI PhÃ¢n tÃ­ch & Äá» xuáº¥t</h3>
      <p class="text-xs text-indigo-600">Chá»n cháº¿ Ä‘á»™ phÃ¢n tÃ­ch phÃ¹ há»£p vá»›i nhu cáº§u cá»§a báº¡n</p>
    </div>
    <div class="flex gap-2">
      <button (click)="analyzeAI('fast')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-green-100 text-green-800 rounded-full hover:bg-green-200 border border-green-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">ğŸš€ Nhanh</span>
        <span class="text-[10px]">Gemini 2.5 Flash</span>
      </button>
      <button (click)="analyzeAI('standard')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 border border-blue-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">âš–ï¸ TiÃªu Chuáº©n</span>
        <span class="text-[10px]">Gemini 2.5 Pro</span>
      </button>
      <button (click)="analyzeAI('deep')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full hover:bg-purple-200 border border-purple-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">ğŸ§  ChuyÃªn SÃ¢u</span>
        <span class="text-[10px]">Gemini 2.5 Pro</span>
      </button>
    </div>
  </div>

  @if (isAnalyzing() || aiResult() || aiError()) {
    <div class="p-5 border border-gray-200 rounded-2xl bg-white shadow-sm min-h-[6rem]">
      @if (isAnalyzing() && !aiResult()) {
        <div class="flex items-center text-gray-500">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>AI Ä‘ang "suy nghÄ©", vui lÃ²ng chá» trong giÃ¢y lÃ¡t...</span>
        </div>
      } @else if (aiError()) {
        <div class="text-red-600">{{ aiError() }}</div>
      } @else if (aiResult() !== null) {
        <div class="prose prose-sm max-w-none text-gray-700" [innerHTML]="formatResponse(aiResult())"></div>
      }
    </div>
  }

  <!-- V2: BCG Matrix -->
  <div class="mb-6">
    <h3 class="font-bold text-gray-700 mb-2">ğŸ“Š PhÃ¢n loáº¡i KOC (Ma tráº­n BCG)</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div (click)="filterBcg('STAR')" class="cursor-pointer transition-all p-3 rounded-lg relative border bg-yellow-50 border-yellow-200 hover:shadow-lg" [class.ring-4]="activeBcgFilter() === 'STAR'" [class.ring-yellow-300]="activeBcgFilter() === 'STAR'" [class.opacity-50]="activeBcgFilter() && activeBcgFilter() !== 'STAR'">
        <div class="absolute top-2 right-2 text-2xl">â­</div>
        <h4 class="font-bold text-yellow-800">NGÃ”I SAO</h4>
        <div class="text-xs text-gray-600">Lá»£i nhuáº­n Cao - GMV Cao</div>
        <div class="mt-2 font-bold text-lg text-yellow-900">{{ bcgGroups().STAR.length }} KOC</div>
        <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().STAR.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
       <div (click)="filterBcg('QUESTION')" class="cursor-pointer transition-all p-3 rounded-lg relative border bg-blue-50 border-blue-200 hover:shadow-lg" [class.ring-4]="activeBcgFilter() === 'QUESTION'" [class.ring-blue-300]="activeBcgFilter() === 'QUESTION'" [class.opacity-50]="activeBcgFilter() && activeBcgFilter() !== 'QUESTION'">
        <div class="absolute top-2 right-2 text-2xl">â“</div>
        <h4 class="font-bold text-blue-800">Dáº¤U Há»I</h4>
        <div class="text-xs text-gray-600">Lá»£i nhuáº­n Cao - GMV Tháº¥p</div>
        <div class="mt-2 font-bold text-lg text-blue-900">{{ bcgGroups().QUESTION.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().QUESTION.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
      <div (click)="filterBcg('COW')" class="cursor-pointer transition-all p-3 rounded-lg relative border bg-green-50 border-green-200 hover:shadow-lg" [class.ring-4]="activeBcgFilter() === 'COW'" [class.ring-green-300]="activeBcgFilter() === 'COW'" [class.opacity-50]="activeBcgFilter() && activeBcgFilter() !== 'COW'">
        <div class="absolute top-2 right-2 text-2xl">ğŸ®</div>
        <h4 class="font-bold text-green-800">BÃ’ Sá»®A</h4>
        <div class="text-xs text-gray-600">Lá»£i nhuáº­n Tháº¥p - GMV Cao</div>
        <div class="mt-2 font-bold text-lg text-green-900">{{ bcgGroups().COW.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().COW.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
      <div (click)="filterBcg('DOG')" class="cursor-pointer transition-all p-3 rounded-lg relative border bg-gray-100 border-gray-200 hover:shadow-lg" [class.ring-4]="activeBcgFilter() === 'DOG'" [class.ring-gray-300]="activeBcgFilter() === 'DOG'" [class.opacity-50]="activeBcgFilter() && activeBcgFilter() !== 'DOG'">
        <div class="absolute top-2 right-2 text-2xl">ğŸ•</div>
        <h4 class="font-bold text-gray-800">CHÃ“ Má»°C</h4>
        <div class="text-xs text-gray-600">Lá»£i nhuáº­n Tháº¥p - GMV Tháº¥p</div>
        <div class="mt-2 font-bold text-lg text-gray-900">{{ bcgGroups().DOG.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().DOG.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-between">
    <div class="flex gap-x-2 rounded-full bg-slate-100 p-1.5">
      <button (click)="viewMode.set('koc')" [class]="viewMode() === 'koc' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        ğŸ‘¤ BÃ¡o CÃ¡o KOC
      </button>
      <button (click)="viewMode.set('product')" [class]="viewMode() === 'product' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        ğŸ“¦ BÃ¡o CÃ¡o Sáº£n Pháº©m
      </button>
    </div>
  </div>

  <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-slate-50 text-xs uppercase text-slate-600">
           @if (viewMode() === 'koc') {
            <tr>
              @for(header of [
                { key: 'kocName', label: 'KOC' },
                { key: 'breakEvenRoas', label: 'ğŸ›¡ï¸ BE ROAS' },
                { key: 'realRoas', label: 'ğŸš€ Real ROAS' },
                { key: 'daysOnHand', label: 'ğŸ“¦ Tá»“n (NgÃ y)' },
                { key: 'returnCancelPercent', label: 'ğŸ“‰ HoÃ n/Há»§y' },
                { key: 'netProfit', label: 'ğŸ’° LÃ£i RÃ²ng' },
                { key: 'aiCommand', label: 'ğŸ¤– AI Lá»‡nh' },
                { key: 'actions', label: 'HÃ nh Ä‘á»™ng' }
              ]; track header.key) {
                <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                  <div class="flex items-center">
                    <span>{{ header.label }}</span>
                    @if(sortKey() === header.key) {
                      <span class="ml-1">{{ sortDirection() === 'asc' ? 'â–²' : 'â–¼' }}</span>
                    }
                  </div>
                </th>
              }
            </tr>
           } @else {
             <tr>
              @for(header of [
                { key: 'productName', label: 'Sáº£n pháº©m' },
                { key: 'breakEvenRoas', label: 'ğŸ›¡ï¸ BE ROAS' },
                { key: 'realRoas', label: 'ğŸš€ Real ROAS' },
                { key: 'daysOnHand', label: 'ğŸ“¦ Tá»“n (NgÃ y)' },
                { key: 'returnRate', label: 'ğŸ“‰ HoÃ n/Há»§y' },
                { key: 'netProfit', label: 'ğŸ’° LÃ£i RÃ²ng' },
                { key: 'aiCommand', label: 'ğŸ¤– AI Lá»‡nh' },
                { key: 'actions', label: 'HÃ nh Ä‘á»™ng' }
              ]; track header.key) {
                <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                  <div class="flex items-center">
                    <span>{{ header.label }}</span>
                    @if(sortKey() === header.key) {
                      <span class="ml-1">{{ sortDirection() === 'asc' ? 'â–²' : 'â–¼' }}</span>
                    }
                  </div>
                </th>
              }
            </tr>
           }
        </thead>
        <tbody class="divide-y divide-gray-200 text-sm">
          @for(item of paginatedData(); track item.kocName || item.productId) {
            <tr class="hover:bg-slate-50" [class.bg-red-50]="item.netProfit < 0">
              <td class="px-4 py-3 font-medium text-indigo-600">{{ item.kocName || item.productName }}</td>
              <td class="px-4 py-3">{{ item.breakEvenRoas === Infinity ? 'N/A' : (item.breakEvenRoas | number:'1.1-1') }}</td>
              <td class="px-4 py-3 font-semibold" [class.text-red-600]="item.healthStatus === 'BLEEDING'">
                {{ item.realRoas | number:'1.1-1' }}
                @if(item.healthStatus === 'BLEEDING') {<span>ğŸ’€</span>}
              </td>
              <td class="px-4 py-3">
                @if(item.daysOnHand < 7) {<span class="font-bold text-red-500 animate-pulse">ğŸš¨</span>}
                {{ item.daysOnHand === Infinity ? 'Háº¿t hÃ ng' : (item.daysOnHand | number:'1.0-0') }}
              </td>
              <td class="px-4 py-3">{{ (item.returnCancelPercent || item.returnRate) | number:'1.1-1' }}%</td>
              <td class="px-4 py-3 font-bold" [class.text-red-600]="item.netProfit < 0" [class.text-green-600]="item.netProfit >= 0">
                {{ item.netProfit | number:'1.0-0' }} Ä‘
              </td>
              <td class="px-4 py-3 font-semibold text-xs">{{ item.aiCommand }}</td>
              <td class="px-4 py-3">
                <button (click)="openWarRoom(item)" class="px-2 py-1 bg-slate-200 text-slate-800 rounded-md text-xs font-semibold hover:bg-slate-300">âš¡ HÃ nh Äá»™ng</button>
              </td>
            </tr>
          } @empty {
            <tr><td colspan="8" class="text-center py-10 text-gray-500">KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ hiá»ƒn thá»‹.</td></tr>
          }
        </tbody>
      </table>
    </div>
    @if (sortedData().length > 0) {
      <app-pagination [totalItems]="sortedData().length" [itemsPerPage]="itemsPerPage()" [currentPage]="currentPage()" (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"></app-pagination>
    }
  </div>
</div>

<!-- War Room Modal -->
@if (isWarRoomOpen()) {
  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-40" (click)="closeWarRoom()"></div>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg" (click)="$event.stopPropagation()">
      <div class="flex items-start justify-between p-4 border-b rounded-t">
        <h3 class="text-xl font-semibold text-gray-900">
          PhÃ²ng TÃ¡c chiáº¿n: <span class="text-indigo-600">{{ warRoomItem().kocName || warRoomItem().productName }}</span>
        </h3>
        <button type="button" (click)="closeWarRoom()" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label for="action-select" class="block text-sm font-medium text-gray-700">Chá»n hÃ nh Ä‘á»™ng:</label>
          <select id="action-select" [value]="warRoomAction()" (change)="warRoomAction.set($event.target.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="">-- Chá»n --</option>
            <option value="TÄƒng ngÃ¢n sÃ¡ch">TÄƒng ngÃ¢n sÃ¡ch</option>
            <option value="Giáº£m ngÃ¢n sÃ¡ch">Giáº£m ngÃ¢n sÃ¡ch</option>
            <option value="Dá»«ng/Táº¡m dá»«ng">Dá»«ng/Táº¡m dá»«ng</option>
            <option value="Gá»­i cáº£nh bÃ¡o">Gá»­i cáº£nh bÃ¡o</option>
            <option value="YÃªu cáº§u tá»‘i Æ°u">YÃªu cáº§u tá»‘i Æ°u</option>
          </select>
        </div>
        <div>
          <label for="action-notes" class="block text-sm font-medium text-gray-700">Ghi chÃº:</label>
          <textarea id="action-notes" rows="3" [value]="warRoomNotes()" (input)="warRoomNotes.set($event.target.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
        </div>
      </div>
      <div class="flex items-center justify-end p-4 border-t">
        <button (click)="closeWarRoom()" type="button" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">Há»§y</button>
        <button (click)="saveWarRoomAction()" type="button" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">LÆ°u vÃ o Log</button>
      </div>
    </div>
  </div>
}