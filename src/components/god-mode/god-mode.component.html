











<div class="space-y-8">
  @if (selectedKoc(); as koc) {
    <!-- Drill-Down View -->
    <div class="space-y-6">
       <button (click)="unselectKoc()" class="inline-flex items-center text-sm font-medium text-gray-600 hover:text-gray-900">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
        Quay l·∫°i B·∫£ng T·ªïng h·ª£p
      </button>

      <h2 class="text-2xl font-bold text-gray-900">üîç Soi chi ti·∫øt KOC: <span class="text-indigo-600">{{ koc.kocName }}</span></h2>

      @if(selectedKocDetails(); as details) {
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div class="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm"><p class="text-sm font-medium text-gray-500">T·ªïng ƒë∆°n KOC n√†y</p><p class="mt-1 text-3xl font-bold text-gray-900">{{ details.totalOrders | number:'1.0-0' }}</p></div>
            <div class="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm"><p class="text-sm font-medium text-gray-500">NMV KOC n√†y</p><p class="mt-1 text-3xl font-bold text-gray-900">{{ details.nmv | number:'1.0-0' }} ƒë</p></div>
            <div class="bg-white p-5 rounded-2xl border" [class]="details.netProfit >= 0 ? 'border-green-300' : 'border-red-300'"><p class="text-sm font-medium text-gray-500">L·ª£i nhu·∫≠n KOC n√†y</p><p class="mt-1 text-3xl font-bold" [class]="details.netProfit >= 0 ? 'text-green-600' : 'text-red-600'">{{ details.netProfit | number:'1.0-0' }} ƒë</p></div>
        </div>
      }

      <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
        <div class="p-4 border-b"><h3 class="text-lg font-medium leading-6 text-gray-900">Chi ti·∫øt hi·ªáu qu·∫£ theo Video/S·∫£n ph·∫©m</h3></div>
        <div class="overflow-x-auto max-h-[60vh]">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-slate-50 text-xs uppercase text-slate-600 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('videoName')">
                            Video / S·∫£n ph·∫©m
                            @if(detailSortKey() === 'videoName') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('revenue')">
                            Doanh thu
                            @if(detailSortKey() === 'revenue') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('cost')">
                            Chi ph√≠
                             @if(detailSortKey() === 'cost') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('returnCount')">
                            Ho√†n/H·ªßy
                             @if(detailSortKey() === 'returnCount') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('commission')">
                            Hoa h·ªìng
                             @if(detailSortKey() === 'commission') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('roi')">
                            ROI
                             @if(detailSortKey() === 'roi') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                        <th class="px-3 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200" (click)="onDetailSort('cir')">
                            CIR
                             @if(detailSortKey() === 'cir') {
                                <span>{{ detailSortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            }
                        </th>
                    </tr>
                </thead>
                 <tbody class="bg-white divide-y divide-gray-200 text-sm">
                    @for(detail of sortedKocDetails(); track detail.videoId) {
                        <tr>
                            <td class="px-3 py-4 whitespace-nowrap">
                                <p class="font-medium text-gray-800 truncate" [title]="detail.videoName">{{ detail.videoName }}</p>
                                <p class="text-xs text-gray-500 font-mono">{{ detail.videoId }}</p>
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-800 font-semibold">{{detail.revenue | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{detail.cost | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{detail.returnCount | number:'1.0-0'}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{detail.commission | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap font-semibold" [class]="detail.roi > 2 ? 'text-green-600' : 'text-gray-700'">{{detail.roi | number:'1.2-2'}}</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{detail.cir | number:'1.1-1'}}%</td>
                        </tr>
                    } @empty {
                        <tr>
                            <td colspan="7" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt cho KOC n√†y.</td>
                        </tr>
                    }
                 </tbody>
            </table>
        </div>
      </div>
    </div>
  } @else {
    <!-- Master Table View -->
    <div>
      <h2 class="text-2xl font-bold text-gray-900">üèÜ GOD MODE - B·∫£ng T·ªïng H·ª£p KOC</h2>
      <p class="mt-1 text-sm text-gray-500">D·ªØ li·ªáu ƒë∆∞·ª£c h·ª£p nh·∫•t t·ª´ Ads, ƒê∆°n h√†ng, v√† T·ªìn kho ƒë·ªÉ ƒë∆∞a ra "S·ª± th·∫≠t Cu·ªëi c√πng": L·ª£i Nhu·∫≠n R√≤ng.</p>
    </div>
    
    <!-- General Overview -->
    <div class="space-y-2">
      <h3 class="text-lg font-medium leading-6 text-gray-900">T·ªïng Quan Chi·∫øn D·ªãch</h3>
      @if (dashboardMetrics(); as metrics) {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
            <p class="text-sm font-medium text-gray-500">T·ªïng Doanh Thu Th·ª±c (NMV)</p>
            <p class="mt-2 text-3xl font-bold tracking-tight text-gray-900">{{ metrics.nmv | number:'1.0-0' }} ƒë</p>
          </div>
          <div class="bg-white p-6 rounded-2xl border" [class]="metrics.netProfit >= 0 ? 'border-green-300 shadow-lg' : 'border-red-300 shadow-lg'">
            <p class="text-sm font-medium text-gray-500">T·ªïng L·ª£i Nhu·∫≠n R√≤ng</p>
            <p class="mt-2 text-3xl font-bold" [class]="metrics.netProfit >= 0 ? 'text-green-600' : 'text-red-600'">{{ metrics.netProfit | number:'1.0-0' }} ƒë</p>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
            <p class="text-sm font-medium text-gray-500">T·ªïng Chi Ph√≠ Ads</p>
            <p class="mt-2 text-3xl font-bold tracking-tight text-gray-900">{{ metrics.adsCost | number:'1.0-0' }} ƒë</p>
            <p class="text-xs text-gray-500 mt-1">(T·ª´ {{ dataService.rawData().length | number:'1.0-0' }} d√≤ng file Ads)</p>
          </div>
          <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
            <p class="text-sm font-medium text-gray-500">T·ª∑ l·ªá Ho√†n/H·ªßy</p>
            <p class="mt-2 text-3xl font-bold tracking-tight text-gray-900">{{ metrics.returnRate | number:'1.1-1' }}%</p>
          </div>
        </div>
      }
    </div>

    <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
        <div class="p-4 border-b flex flex-col sm:flex-row items-center justify-end gap-4">
            <div class="flex items-center gap-x-2">
                <label for="sort-select" class="text-sm font-medium text-gray-700">S·∫Øp x·∫øp theo:</label>
                <select id="sort-select" [value]="sortKey()" (change)="onSortChange($event)" class="block rounded-lg border-transparent bg-slate-100 py-2 pl-3 pr-8 text-base focus:bg-white focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm shadow-sm">
                    <option value="netProfit_desc">L·ª£i nhu·∫≠n gi·∫£m d·∫ßn</option>
                    <option value="netProfit_asc">L·ª£i nhu·∫≠n tƒÉng d·∫ßn</option>
                    <option value="nmv_desc">NMV gi·∫£m d·∫ßn</option>
                    <option value="adsGmv_desc">GMV (Ads) gi·∫£m d·∫ßn</option>
                    <option value="adsCost_desc">Chi ph√≠ Ads gi·∫£m d·∫ßn</option>
                    <option value="totalCogs_desc">Gi√° v·ªën gi·∫£m d·∫ßn</option>
                    <option value="totalCommission_desc">Hoa h·ªìng gi·∫£m d·∫ßn</option>
                </select>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-slate-50 text-xs uppercase text-slate-600">
                    <tr>
                        <th class="px-3 py-3 text-left font-semibold">KOC</th>
                        <th class="px-3 py-3 text-left font-semibold">üî¥ Chi ph√≠ Ads</th>
                        <th class="px-3 py-3 text-left font-semibold">üîµ GMV (Ads)</th>
                        <th class="px-3 py-3 text-left font-semibold">üü¢ NMV (Th·ª±c)</th>
                        <th class="px-3 py-3 text-left font-semibold">üì¶ Gi√° V·ªën</th>
                        <th class="px-3 py-3 text-left font-semibold">üí∏ Hoa H·ªìng</th>
                        <th class="px-3 py-3 text-left font-semibold">üìâ % Ho√†n/H·ªßy</th>
                        <th class="px-3 py-3 text-left font-semibold">üí∞ L·ª¢I NHU·∫¨N R√íNG</th>
                        <th class="px-3 py-3 text-left font-semibold">üí° G·ª£i √Ω</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 text-sm">
                    @for(koc of paginatedData(); track koc.kocName) {
                        <tr class="hover:bg-slate-50" [class.bg-red-50]="koc.netProfit < 0 || (koc.adsCost > 0 && koc.nmv === 0)">
                            <td class="px-3 py-4 whitespace-nowrap">
                                <button (click)="selectKoc(koc)" class="font-medium text-indigo-600 hover:text-indigo-800 hover:underline text-left">
                                    {{koc.kocName}}
                                </button>
                                @if (koc.latestVideoLink) {
                                    <a [href]="koc.latestVideoLink" target="_blank" class="text-indigo-600 hover:text-indigo-800 hover:underline ml-2">[Video]</a>
                                }
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{koc.adsCost | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{koc.adsGmv | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap font-semibold text-blue-600">{{koc.nmv | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{koc.totalCogs | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{koc.totalCommission | number:'1.0-0'}} ƒë</td>
                            <td class="px-3 py-4 whitespace-nowrap text-gray-500">{{koc.returnCancelPercent | number:'1.1-1'}}%</td>
                            <td class="px-3 py-4 whitespace-nowrap font-bold flex items-center gap-x-2" [class]="koc.netProfit >= 0 ? 'text-green-600' : 'text-red-600'">
                                {{koc.netProfit | number:'1.0-0'}} ƒë
                            </td>
                            <td class="px-3 py-4 whitespace-nowrap">
                                @if(koc.suggestion) {
                                    <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" [class]="koc.suggestionColor">
                                        {{ koc.suggestion }}
                                    </span>
                                }
                            </td>
                        </tr>
                    } @empty {
                        <tr>
                            <td colspan="9" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (sortedData().length > 0) {
            <app-pagination
                [totalItems]="sortedData().length"
                [itemsPerPage]="itemsPerPage()"
                [currentPage]="currentPage()"
                (pageChange)="onPageChange($event)"
                (itemsPerPageChange)="onItemsPerPageChange($event)">
            </app-pagination>
        }
    </div>
  }
</div>
