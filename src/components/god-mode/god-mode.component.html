<div class="space-y-8">
  <div>
    <h2 class="text-2xl font-bold text-gray-900">üèÜ GOD MODE - B·∫£ng T·ªïng H·ª£p</h2>
    <p class="mt-1 text-sm text-gray-500">D·ªØ li·ªáu h·ª£p nh·∫•t t·ª´ Ads, ƒê∆°n h√†ng, v√† T·ªìn kho ƒë·ªÉ ƒë∆∞a ra "S·ª± th·∫≠t Cu·ªëi c√πng": L·ª£i Nhu·∫≠n R√≤ng.</p>
  </div>

  <div class="flex items-center justify-between">
    <div class="flex gap-x-2 rounded-full bg-slate-100 p-1.5">
      <button (click)="viewMode.set('koc')" [class]="viewMode() === 'koc' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        üë§ B√°o C√°o KOC
      </button>
      <button (click)="viewMode.set('product')" [class]="viewMode() === 'product' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        üì¶ B√°o C√°o S·∫£n Ph·∫©m
      </button>
    </div>
  </div>

  @if (viewMode() === 'koc') {
    <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-slate-50 text-xs uppercase text-slate-600">
            <tr>
              @for(header of [
                { key: 'kocName', label: 'KOC' },
                { key: 'adsCost', label: 'üî¥ Chi ph√≠ Ads' },
                { key: 'adsGmv', label: 'üîµ GMV (Ads)' },
                { key: 'nmv', label: 'üü¢ NMV (Th·ª±c)' },
                { key: 'netProfit', label: 'üí∞ L·ª£i Nhu·∫≠n' },
                { key: 'returnCancelPercent', label: 'üìâ % Ho√†n/H·ªßy' }
              ]; track header.key) {
                <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                  <div class="flex items-center">
                    <span>{{ header.label }}</span>
                    @if(sortKey() === header.key) {
                      <span class="ml-1">{{ sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                    }
                  </div>
                </th>
              }
              <th class="px-4 py-3 text-left font-semibold">ƒê√°nh gi√°</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-sm">
            @for(item of paginatedData(); track item.kocName) {
              @let insight = getKocInsight(item);
              <ng-container>
                <tr class="hover:bg-slate-50 cursor-pointer" [class.bg-red-50]="item.netProfit < 0" (click)="selectKoc(item)">
                  <td class="px-4 py-3 font-medium text-indigo-600">{{ item.kocName }}</td>
                  <td class="px-4 py-3">{{ item.adsCost | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3">{{ item.adsGmv | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3 font-semibold text-blue-700">{{ item.nmv | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3 font-bold" [class.text-red-600]="item.netProfit < 0" [class.text-green-600]="item.netProfit >= 0">
                    {{ item.netProfit | number:'1.0-0' }} ƒë
                  </td>
                  <td class="px-4 py-3">{{ item.returnCancelPercent | number:'1.1-1' }}%</td>
                  <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-bold" [class]="insight.color">
                      {{ insight.tag }}
                    </span>
                  </td>
                </tr>

                @if (selectedKoc() === item) {
                  <tr>
                    <td colspan="7" class="bg-slate-100 p-4">
                      <h4 class="text-sm font-bold mb-2 text-gray-800">üîç Chi ti·∫øt Video & ƒê∆°n h√†ng c·ªßa {{ item.kocName }}:</h4>
                      <div class="max-h-80 overflow-y-auto rounded-lg border bg-white">
                        <table class="w-full text-xs">
                          <thead class="bg-slate-50 sticky top-0">
                            <tr class="text-slate-600">
                              <th class="p-2 text-left">ID Video / Actions</th>
                              <th class="p-2 text-left">T√™n Video</th>
                              <th class="p-2 text-left">S·∫£n ph·∫©m (ID)</th>
                              <th class="p-2 text-left">Doanh thu</th>
                              <th class="p-2 text-left">Ho√†n/H·ªßy</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y">
                            @for(detail of sortedKocDetails(); track detail.videoId) {
                              <tr class="hover:bg-slate-50">
                                <td class="p-2">
                                  <div class="flex items-center gap-2">
                                    <span class="font-mono text-gray-500" [title]="detail.videoId">{{ detail.videoId | slice:0:8 }}...</span>
                                    <button (click)="copyToClipboard(detail.videoId)" title="Copy ID" class="text-gray-400 hover:text-blue-600">
                                       @if (copiedVideoId() === detail.videoId) {
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                       } @else {
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                       }
                                    </button>
                                    <a [href]="getTikTokVideoLink(item.kocName, detail.videoId)" target="_blank" title="Xem tr√™n TikTok" class="text-gray-400 hover:text-pink-600">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    </a>
                                  </div>
                                </td>
                                <td class="p-2 max-w-[200px]"><div class="truncate" title="{{ detail.videoName }}">{{ detail.videoName || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)' }}</div></td>
                                <td class="p-2"><div class="font-medium">{{ detail.productName }}</div><div class="text-gray-400">ID: {{ detail.productId }}</div></td>
                                <td class="p-2">{{ detail.revenue | number:'1.0-0' }} ƒë</td>
                                <td class="p-2 text-red-500">{{ detail.returnCount }} ƒë∆°n</td>
                              </tr>
                            } @empty {
                              <tr><td colspan="5" class="p-4 text-center text-gray-500">Kh√¥ng c√≥ chi ti·∫øt.</td></tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    </td>
                  </tr>
                }
              </ng-container>
            } @empty {
              <tr><td colspan="7" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</td></tr>
            }
          </tbody>
        </table>
      </div>
      @if (sortedData().length > 0) {
        <app-pagination [totalItems]="sortedData().length" [itemsPerPage]="itemsPerPage()" [currentPage]="currentPage()" (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"></app-pagination>
      }
    </div>
  } @else if (viewMode() === 'product') {
    <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
       <div class="p-4 border-b"><h3 class="text-lg font-medium leading-6 text-gray-900">üìä Hi·ªáu Qu·∫£ Theo S·∫£n Ph·∫©m</h3></div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-slate-50 text-xs uppercase text-slate-600">
                  <tr>
                    @for(header of [
                      { key: 'productName', label: 'T√™n S·∫£n Ph·∫©m / SKU' },
                      { key: 'successCount', label: 'ƒê∆°n Th√†nh C√¥ng' },
                      { key: 'nmv', label: 'Doanh Thu Th·ª±c' },
                      { key: 'cogs', label: 'Gi√° V·ªën' },
                      { key: 'netProfit', label: 'L·ª£i Nhu·∫≠n' },
                      { key: 'returnRate', label: '% Ho√†n/H·ªßy' }
                    ]; track header.key) {
                      <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                        <div class="flex items-center">
                          <span>{{ header.label }}</span>
                          @if(sortKey() === header.key) {
                            <span class="ml-1">{{ sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                          }
                        </div>
                      </th>
                    }
                  </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 text-sm">
                  @for(prod of paginatedData(); track prod.productId) {
                      <tr class="hover:bg-slate-50">
                          <td class="px-4 py-3"><div class="font-medium text-gray-800">{{ prod.productName }}</div><div class="text-xs text-gray-500">SKU: {{ prod.sku }}</div></td>
                          <td class="px-4 py-3 text-center">{{ prod.successCount | number:'1.0-0' }}</td>
                          <td class="px-4 py-3">{{ prod.nmv | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3">{{ prod.cogs | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3 font-bold" [class.text-green-600]="prod.netProfit >= 0" [class.text-red-600]="prod.netProfit < 0">{{ prod.netProfit | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3">{{ prod.returnRate | number:'1.1-1' }}%</td>
                      </tr>
                  } @empty {
                      <tr><td colspan="6" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã.</td></tr>
                  }
              </tbody>
          </table>
        </div>
         @if (sortedData().length > 0) {
            <app-pagination [totalItems]="sortedData().length" [itemsPerPage]="itemsPerPage()" [currentPage]="currentPage()" (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"></app-pagination>
        }
    </div>
  }
</div>