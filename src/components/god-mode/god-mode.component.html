<div class="space-y-8">
  <div>
    <h2 class="text-2xl font-bold text-gray-900">üèÜ GOD MODE - B·∫£ng T·ªïng H·ª£p</h2>
    <p class="mt-1 text-sm text-gray-500">D·ªØ li·ªáu h·ª£p nh·∫•t t·ª´ Ads, ƒê∆°n h√†ng, v√† T·ªìn kho ƒë·ªÉ ƒë∆∞a ra "S·ª± th·∫≠t Cu·ªëi c√πng": L·ª£i Nhu·∫≠n R√≤ng.</p>
  </div>

  <!-- V2: Executive Summary -->
  @if(summary(); as s) {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
        <div class="text-gray-500 text-sm">Doanh Thu Th·ª±c (NMV)</div>
        <div class="text-2xl font-bold text-blue-700">{{ s.totalNMV | number:'1.0-0' }} ‚Ç´</div>
        <div class="text-xs text-gray-400">GMV (ƒê∆°n): {{ s.totalRevenue | number:'1.0-0' }} ‚Ç´</div>
      </div>
      
      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
        <div class="text-gray-500 text-sm">L·ª£i Nhu·∫≠n R√≤ng</div>
        <div class="text-2xl font-bold" [class.text-red-600]="s.totalNetProfit < 0" [class.text-green-600]="s.totalNetProfit >= 0">
          {{ s.totalNetProfit | number:'1.0-0' }} ‚Ç´
        </div>
        <div class="text-xs text-gray-400">T·ª´ {{ s.totalNMV | number:'1.0-0' }} ƒë NMV</div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
        <div class="text-gray-500 text-sm">Hi·ªáu Qu·∫£ KOC</div>
        <div class="text-2xl font-bold">{{ s.activeKoc }} / {{ s.totalKoc }}</div>
        <div class="text-xs text-gray-400">ƒêang ra ƒë∆°n</div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
        <div class="text-gray-500 text-sm">T·ª∑ L·ªá Ho√†n/H·ªßy</div>
        <div class="text-2xl font-bold text-red-600">{{ s.avgReturnRate | number:'1.1-1' }}%</div>
        <div class="text-xs text-gray-400">Tr√™n t·ªïng ƒë∆°n</div>
      </div>
    </div>
  }

  <!-- V2: AI Assistant -->
  <div class="bg-indigo-50 p-4 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-4">
    <div>
      <h3 class="font-bold text-indigo-800">ü§ñ Tr·ª£ l√Ω AI Ph√¢n t√≠ch & ƒê·ªÅ xu·∫•t</h3>
      <p class="text-xs text-indigo-600">Ch·ªçn ch·∫ø ƒë·ªô ph√¢n t√≠ch ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa b·∫°n</p>
    </div>
    <div class="flex gap-2">
      <button (click)="analyzeAI('fast')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-green-100 text-green-800 rounded-full hover:bg-green-200 border border-green-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">üöÄ Nhanh</span>
        <span class="text-[10px]">Gemini 2.5 Flash</span>
      </button>
      <button (click)="analyzeAI('standard')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 border border-blue-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">‚öñÔ∏è Ti√™u Chu·∫©n</span>
        <span class="text-[10px]">Gemini 2.5 Pro</span>
      </button>
      <button (click)="analyzeAI('deep')" [disabled]="isAnalyzing()" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-full hover:bg-purple-200 border border-purple-300 flex flex-col items-center disabled:opacity-50 disabled:cursor-wait">
        <span class="font-bold">üß† Chuy√™n S√¢u</span>
        <span class="text-[10px]">Gemini 2.5 Pro</span>
      </button>
    </div>
  </div>

  @if (isAnalyzing() || aiResult() || aiError()) {
    <div class="p-5 border border-gray-200 rounded-2xl bg-white shadow-sm min-h-[6rem]">
      @if (isAnalyzing() && !aiResult()) {
        <div class="flex items-center text-gray-500">
            <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>AI ƒëang "suy nghƒ©", vui l√≤ng ch·ªù trong gi√¢y l√°t...</span>
        </div>
      } @else if (aiError()) {
        <div class="text-red-600">{{ aiError() }}</div>
      } @else if (aiResult() !== null) {
        <div class="prose prose-sm max-w-none text-gray-700" [innerHTML]="formatResponse(aiResult())"></div>
      }
    </div>
  }

  <!-- V2: BCG Matrix -->
  <div class="mb-6">
    <h3 class="font-bold text-gray-700 mb-2">üìä Ph√¢n lo·∫°i KOC (Ma tr·∫≠n BCG)</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg relative">
        <div class="absolute top-2 right-2 text-2xl">‚≠ê</div>
        <h4 class="font-bold text-yellow-800">NG√îI SAO</h4>
        <div class="text-xs text-gray-600">L·ª£i nhu·∫≠n Cao - GMV Cao</div>
        <div class="mt-2 font-bold text-lg text-yellow-900">{{ bcgGroups().STAR.length }} KOC</div>
        <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().STAR.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
       <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg relative">
        <div class="absolute top-2 right-2 text-2xl">‚ùì</div>
        <h4 class="font-bold text-blue-800">D·∫§U H·ªéI</h4>
        <div class="text-xs text-gray-600">L·ª£i nhu·∫≠n Cao - GMV Th·∫•p</div>
        <div class="mt-2 font-bold text-lg text-blue-900">{{ bcgGroups().QUESTION.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().QUESTION.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
      <div class="bg-green-50 border border-green-200 p-3 rounded-lg relative">
        <div class="absolute top-2 right-2 text-2xl">üêÆ</div>
        <h4 class="font-bold text-green-800">B√í S·ªÆA</h4>
        <div class="text-xs text-gray-600">L·ª£i nhu·∫≠n Th·∫•p - GMV Cao</div>
        <div class="mt-2 font-bold text-lg text-green-900">{{ bcgGroups().COW.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().COW.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
      <div class="bg-gray-100 border border-gray-200 p-3 rounded-lg relative">
        <div class="absolute top-2 right-2 text-2xl">üêï</div>
        <h4 class="font-bold text-gray-800">CH√ì M·ª∞C</h4>
        <div class="text-xs text-gray-600">L·ª£i nhu·∫≠n Th·∫•p - GMV Th·∫•p</div>
        <div class="mt-2 font-bold text-lg text-gray-900">{{ bcgGroups().DOG.length }} KOC</div>
         <div class="text-xs mt-1 text-gray-500 truncate h-4">
          @for(k of bcgGroups().DOG.slice(0, 5); track k.kocName){<span>{{ k.kocName }}, </span>}
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-between">
    <div class="flex gap-x-2 rounded-full bg-slate-100 p-1.5">
      <button (click)="viewMode.set('koc')" [class]="viewMode() === 'koc' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        üë§ B√°o C√°o KOC
      </button>
      <button (click)="viewMode.set('product')" [class]="viewMode() === 'product' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:bg-slate-200/60'" class="px-5 py-2 rounded-full text-sm font-semibold transition-colors">
        üì¶ B√°o C√°o S·∫£n Ph·∫©m
      </button>
    </div>
  </div>

  @if (viewMode() === 'koc') {
    <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-slate-50 text-xs uppercase text-slate-600">
            <tr>
              @for(header of [
                { key: 'kocName', label: 'KOC' },
                { key: 'adsCost', label: 'üî¥ Chi ph√≠ Ads' },
                { key: 'adsGmv', label: 'üîµ GMV (Ads)' },
                { key: 'nmv', label: 'üü¢ NMV (Th·ª±c)' },
                { key: 'netProfit', label: 'üí∞ L·ª£i Nhu·∫≠n' },
                { key: 'returnCancelPercent', label: 'üìâ % Ho√†n/H·ªßy' }
              ]; track header.key) {
                <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                  <div class="flex items-center">
                    <span>{{ header.label }}</span>
                    @if(sortKey() === header.key) {
                      <span class="ml-1">{{ sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                    }
                  </div>
                </th>
              }
              <th class="px-4 py-3 text-left font-semibold">ƒê√°nh gi√°</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-sm">
            @for(item of paginatedData(); track item.kocName) {
              @let insight = getKocInsight(item);
              <ng-container>
                <tr class="hover:bg-slate-50 cursor-pointer" [class.bg-red-50]="item.netProfit < 0" (click)="selectKoc(item)">
                  <td class="px-4 py-3 font-medium text-indigo-600">{{ item.kocName }}</td>
                  <td class="px-4 py-3">{{ item.adsCost | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3">{{ item.adsGmv | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3 font-semibold text-blue-700">{{ item.nmv | number:'1.0-0' }} ƒë</td>
                  <td class="px-4 py-3 font-bold" [class.text-red-600]="item.netProfit < 0" [class.text-green-600]="item.netProfit >= 0">
                    {{ item.netProfit | number:'1.0-0' }} ƒë
                  </td>
                  <td class="px-4 py-3">{{ item.returnCancelPercent | number:'1.1-1' }}%</td>
                  <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-bold" [class]="insight.color">
                      {{ insight.tag }}
                    </span>
                  </td>
                </tr>

                @if (selectedKoc() === item) {
                  <tr>
                    <td colspan="7" class="bg-slate-100 p-4">
                      <h4 class="text-sm font-bold mb-2 text-gray-800">üîç Chi ti·∫øt Video & ƒê∆°n h√†ng c·ªßa {{ item.kocName }}:</h4>
                      <div class="max-h-80 overflow-y-auto rounded-lg border bg-white">
                        <table class="w-full text-xs">
                          <thead class="bg-slate-50 sticky top-0">
                            <tr class="text-slate-600">
                              <th class="p-2 text-left">ID Video / Actions</th>
                              <th class="p-2 text-left">T√™n Video</th>
                              <th class="p-2 text-left">S·∫£n ph·∫©m (ID)</th>
                              <th class="p-2 text-left">Doanh thu</th>
                              <th class="p-2 text-left">Ho√†n/H·ªßy</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y">
                            @for(detail of sortedKocDetails(); track detail.videoId) {
                              <tr class="hover:bg-slate-50">
                                <td class="p-2">
                                  <div class="flex items-center gap-2">
                                    <span class="font-mono text-gray-500" [title]="detail.videoId">{{ detail.videoId | slice:0:8 }}...</span>
                                    <button (click)="copyToClipboard(detail.videoId)" title="Copy ID" class="text-gray-400 hover:text-blue-600">
                                       @if (copiedVideoId() === detail.videoId) {
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                       } @else {
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                                       }
                                    </button>
                                    <a [href]="getTikTokVideoLink(item.kocName, detail.videoId)" target="_blank" title="Xem tr√™n TikTok" class="text-gray-400 hover:text-pink-600">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    </a>
                                  </div>
                                </td>
                                <td class="p-2 max-w-[200px]"><div class="truncate" title="{{ detail.videoName }}">{{ detail.videoName || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)' }}</div></td>
                                <td class="p-2"><div class="font-medium">{{ detail.productName }}</div><div class="text-gray-400">ID: {{ detail.productId }}</div></td>
                                <td class="p-2">{{ detail.revenue | number:'1.0-0' }} ƒë</td>
                                <td class="p-2 text-red-500">{{ detail.returnCount }} ƒë∆°n</td>
                              </tr>
                            } @empty {
                              <tr><td colspan="5" class="p-4 text-center text-gray-500">Kh√¥ng c√≥ chi ti·∫øt.</td></tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    </td>
                  </tr>
                }
              </ng-container>
            } @empty {
              <tr><td colspan="7" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</td></tr>
            }
          </tbody>
        </table>
      </div>
      @if (sortedData().length > 0) {
        <app-pagination [totalItems]="sortedData().length" [itemsPerPage]="itemsPerPage()" [currentPage]="currentPage()" (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"></app-pagination>
      }
    </div>
  } @else if (viewMode() === 'product') {
    <div class="bg-white shadow-sm overflow-hidden rounded-2xl border border-gray-200">
       <div class="p-4 border-b"><h3 class="text-lg font-medium leading-6 text-gray-900">üìä Hi·ªáu Qu·∫£ Theo S·∫£n Ph·∫©m</h3></div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-slate-50 text-xs uppercase text-slate-600">
                  <tr>
                    @for(header of [
                      { key: 'productName', label: 'T√™n S·∫£n Ph·∫©m / SKU' },
                      { key: 'successCount', label: 'ƒê∆°n Th√†nh C√¥ng' },
                      { key: 'nmv', label: 'Doanh Thu Th·ª±c' },
                      { key: 'cogs', label: 'Gi√° V·ªën' },
                      { key: 'netProfit', label: 'L·ª£i Nhu·∫≠n' },
                      { key: 'returnRate', label: '% Ho√†n/H·ªßy' }
                    ]; track header.key) {
                      <th (click)="onSort(header.key)" class="px-4 py-3 text-left font-semibold cursor-pointer hover:bg-slate-200">
                        <div class="flex items-center">
                          <span>{{ header.label }}</span>
                          @if(sortKey() === header.key) {
                            <span class="ml-1">{{ sortDirection() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                          }
                        </div>
                      </th>
                    }
                  </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 text-sm">
                  @for(prod of paginatedData(); track prod.productId) {
                      <tr class="hover:bg-slate-50">
                          <td class="px-4 py-3"><div class="font-medium text-gray-800">{{ prod.productName }}</div><div class="text-xs text-gray-500">SKU: {{ prod.sku }}</div></td>
                          <td class="px-4 py-3 text-center">{{ prod.successCount | number:'1.0-0' }}</td>
                          <td class="px-4 py-3">{{ prod.nmv | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3">{{ prod.cogs | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3 font-bold" [class.text-green-600]="prod.netProfit >= 0" [class.text-red-600]="prod.netProfit < 0">{{ prod.netProfit | number:'1.0-0' }} ƒë</td>
                          <td class="px-4 py-3">{{ prod.returnRate | number:'1.1-1' }}%</td>
                      </tr>
                  } @empty {
                      <tr><td colspan="6" class="text-center py-10 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m ƒë·ªÉ hi·ªÉn th·ªã.</td></tr>
                  }
              </tbody>
          </table>
        </div>
         @if (sortedData().length > 0) {
            <app-pagination [totalItems]="sortedData().length" [itemsPerPage]="itemsPerPage()" [currentPage]="currentPage()" (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"></app-pagination>
        }
    </div>
  }
</div>