<div class="p-6 bg-gray-50 min-h-screen">
  
  @let summary = summary();
  <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
    <h2 class="text-gray-500 font-bold text-xs uppercase tracking-wide mb-3">S·ª©c Kh·ªèe D√≤ng Ti·ªÅn (P&L Overview)</h2>
    <div class="grid grid-cols-5 gap-4 text-center divide-x">
      <div>
        <div class="text-xs text-gray-400">Doanh Thu (GMV)</div>
        <div class="text-lg font-bold text-gray-800">{{ summary.totalRevenue | number }}</div>
      </div>
      <div>
        <div class="text-xs text-gray-400">Th·ª±c Thu (NMV)</div>
        <div class="text-lg font-bold text-blue-600">{{ summary.totalNMV | number }}</div>
      </div>
      <div>
        <div class="text-xs text-gray-400">T·ªïng Chi Ph√≠ Ads</div>
        <div class="text-lg font-bold text-red-500">{{ summary.totalAdsCost | number }}</div>
      </div>
      <div>
        <div class="text-xs text-gray-400">T·ªïng Gi√° V·ªën</div>
        <div class="text-lg font-bold text-gray-600">{{ summary.totalCOGS | number }}</div>
      </div>
      <div>
        <div class="text-xs text-gray-400">L·ª£i Nhu·∫≠n R√≤ng</div>
        <div class="text-xl font-black" 
             [class.text-green-600]="summary.totalNetProfit > 0" 
             [class.text-red-600]="summary.totalNetProfit < 0">
          {{ summary.totalNetProfit | number }}
        </div>
      </div>
    </div>
    
    <div class="mt-4 h-2 bg-gray-100 rounded-full overflow-hidden flex">
      <div class="bg-red-400 h-full" [style.width.%]="(summary.totalAdsCost / summary.totalNMV) * 100" title="Ads Cost"></div>
      <div class="bg-gray-400 h-full" [style.width.%]="(summary.totalCOGS / summary.totalNMV) * 100" title="COGS"></div>
      <div class="bg-green-500 h-full flex-1" title="Profit"></div>
    </div>
  </div>

  @let bcgGroups = bcgGroups();
  <div class="grid grid-cols-4 gap-4 mb-6">
    <div (click)="filterBcg('STAR')" 
         class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg cursor-pointer hover:shadow-md transition-all relative overflow-hidden"
         [class.ring-2]="activeBcgFilter() === 'STAR'" [class.ring-yellow-400]="activeBcgFilter() === 'STAR'">
      <div class="text-2xl mb-1">‚≠ê NG√îI SAO</div>
      <div class="text-xs text-gray-500 mb-2">L√£i Cao - Doanh s·ªë Cao</div>
      <div class="font-bold text-xl">{{ bcgGroups.STAR?.length || 0 }} KOC</div>
      <div class="absolute -right-4 -bottom-4 text-6xl opacity-10">‚òÖ</div>
    </div>
    
    <div (click)="filterBcg('COW')" class="bg-green-50 border border-green-200 p-4 rounded-lg cursor-pointer hover:shadow-md transition-all relative overflow-hidden"
         [class.ring-2]="activeBcgFilter() === 'COW'" [class.ring-green-400]="activeBcgFilter() === 'COW'">
      <div class="text-2xl mb-1">üêÆ B√í S·ªÆA</div>
      <div class="text-xs text-gray-500 mb-2">L√£i Th·∫•p - Doanh s·ªë Cao</div>
      <div class="font-bold text-xl">{{ bcgGroups.COW?.length || 0 }} KOC</div>
    </div>

    <div (click)="filterBcg('QUESTION')" class="bg-blue-50 border border-blue-200 p-4 rounded-lg cursor-pointer hover:shadow-md transition-all relative overflow-hidden"
         [class.ring-2]="activeBcgFilter() === 'QUESTION'" [class.ring-blue-400]="activeBcgFilter() === 'QUESTION'">
      <div class="text-2xl mb-1">‚ùì D·∫§U H·ªéI</div>
      <div class="text-xs text-gray-500 mb-2">L√£i Cao - Doanh s·ªë Th·∫•p</div>
      <div class="font-bold text-xl">{{ bcgGroups.QUESTION?.length || 0 }} KOC</div>
    </div>

    <div (click)="filterBcg('DOG')" class="bg-gray-100 border border-gray-200 p-4 rounded-lg cursor-pointer hover:shadow-md transition-all relative overflow-hidden"
         [class.ring-2]="activeBcgFilter() === 'DOG'" [class.ring-gray-400]="activeBcgFilter() === 'DOG'">
      <div class="text-2xl mb-1">üêï CH√ì M·ª∞C</div>
      <div class="text-xs text-gray-500 mb-2">L·ªó/L√£i Th·∫•p - Doanh s·ªë Th·∫•p</div>
      <div class="font-bold text-xl">{{ bcgGroups.DOG?.length || 0 }} KOC</div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="w-full text-sm text-left">
      <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
        <tr>
          <th class="p-3">KOC</th>
          <th class="p-3 cursor-pointer" (click)="sortBy('adsCost')">üî¥ ADS COST ‚áÖ</th>
          <th class="p-3 cursor-pointer" (click)="sortBy('gmv')">üîµ GMV ‚áÖ</th>
          <th class="p-3 cursor-pointer" (click)="sortBy('nmv')">üü¢ NMV (TH·ª∞C) ‚áÖ</th>
          <th class="p-3 cursor-pointer" (click)="sortBy('cogs')">üì¶ GI√Å V·ªêN ‚áÖ</th>
          <th class="p-3 cursor-pointer" (click)="sortBy('netProfit')">üí∞ L·ª¢I NHU·∫¨N ‚áÖ</th>
          <th class="p-3">H√ÄNH ƒê·ªòNG</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        @for (item of sortedData(); track item.mergeKey) {
          <tr class="hover:bg-gray-50 cursor-pointer transition-colors" 
              [class.bg-blue-50]="selectedKoc() === item"
              (click)="selectKoc(item)">
            <td class="p-3 font-medium text-blue-700 flex items-center gap-2">
              @if (selectedKoc() === item) {
                <span>‚ñº</span>
              } @else {
                <span>‚ñ∂</span>
              }
              {{ item.kocName }}
            </td>
            <td class="p-3 text-red-600">{{ item.adsCost | number }}</td>
            <td class="p-3 text-gray-500">{{ item.gmv | number }}</td>
            <td class="p-3 font-bold text-blue-600">{{ item.nmv | number }}</td>
            <td class="p-3 text-gray-500">{{ item.cogs | number }}</td>
            <td class="p-3 font-bold text-base" 
                [class.text-green-600]="item.netProfit > 0" 
                [class.text-red-600]="item.netProfit < 0">
              {{ item.netProfit | number }}
            </td>
            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-bold"
                    [class.bg-yellow-100]="item.bcgLabel === 'STAR'"
                    [class.bg-green-100]="item.bcgLabel === 'COW'"
                    [class.bg-blue-100]="item.bcgLabel === 'QUESTION'"
                    [class.bg-gray-100]="item.bcgLabel === 'DOG'">
                {{ item.bcgLabel }}
              </span>
            </td>
          </tr>

          @if (selectedKoc() === item) {
            <tr class="bg-gray-50">
              <td colspan="7" class="p-4">
                <div class="mb-2 font-bold text-gray-700">Chi ti·∫øt s·∫£n ph·∫©m & Video c·ªßa {{ item.kocName }}:</div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full bg-white border text-xs rounded overflow-hidden">
                      <thead class="bg-blue-100 sticky top-0">
                        <tr>
                          <th class="p-2">Video ID / Link</th>
                          <th class="p-2">S·∫£n Ph·∫©m</th>
                          <th class="p-2 text-right">Gi√° B√°n</th>
                          <th class="p-2 text-right">Gi√° V·ªën</th>
                          <th class="p-2 text-right">Hoa H·ªìng</th>
                          <th class="p-2 text-right">L√£i G·ªôp ƒê∆°n</th>
                          <th class="p-2 text-center">Tr·∫°ng Th√°i</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (detail of kocDetails(); track detail.orderId) {
                          <tr class="border-b">
                            <td class="p-2 font-mono">
                              @if(detail.videoId && detail.videoId !== 'N/A') {
                                <a [href]="'https://tiktok.com/@'+item.kocName+'/video/'+detail.videoId" target="_blank" class="text-blue-500 hover:underline">
                                  {{ detail.videoId }} üîó
                                </a>
                              } @else {
                                <span>N/A</span>
                              }
                            </td>
                            <td class="p-2 max-w-xs truncate" [title]="detail.productName">{{ detail.productName }}</td>
                            <td class="p-2 text-right">{{ detail.revenue | number }}</td>
                            <td class="p-2 text-right text-gray-500">{{ detail.cogs | number }}</td>
                            <td class="p-2 text-right text-gray-500">{{ detail.commission | number }}</td>
                            <td class="p-2 text-right font-bold" [class.text-green-600]="detail.profit > 0">{{ detail.profit | number }}</td>
                            <td class="p-2 text-center">
                              @if (detail.isReturn) {
                                <span class="text-red-500 font-bold">HO√ÄN/H·ª¶Y</span>
                              } @else {
                                <span class="text-green-500">Th√†nh c√¥ng</span>
                              }
                            </td>
                          </tr>
                        } @empty {
                          <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">Kh√¥ng c√≥ chi ti·∫øt ƒë∆°n h√†ng cho KOC n√†y.</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                </div>
              </td>
            </tr>
          }
        } @empty {
            <tr>
              <td colspan="7" class="text-center p-8 text-gray-500">
                Kh√¥ng c√≥ d·ªØ li·ªáu P&L ƒë·ªÉ hi·ªÉn th·ªã. <br/> Vui l√≤ng t·∫£i l√™n file Ads, file ƒê∆°n h√†ng, v√† file T·ªìn kho.
              </td>
            </tr>
        }
      </tbody>
    </table>
  </div>
</div>
